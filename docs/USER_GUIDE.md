# Руководство пользователя

Данное руководство описывает, как настраивать, запускать и обслуживать приложение `storage_to_git`.

## Оглавление

- [Руководство пользователя](#руководство-пользователя)
  - [Оглавление](#оглавление)
  - [1. Структура конфигурационного файла `config.json`](#1-структура-конфигурационного-файла-configjson)
    - [Глобальные настройки](#глобальные-настройки)
    - [Настройки проекта (объект в массиве `projects`)](#настройки-проекта-объект-в-массиве-projects)
    - [Файл сопоставления пользователей (`users.csv`)](#файл-сопоставления-пользователей-userscsv)
      - [Объект `infobase`](#объект-infobase)
      - [Объект `storage` (основное хранилище)](#объект-storage-основное-хранилище)
      - [Объект `extensions` (элемент массива)](#объект-extensions-элемент-массива)
  - [2. Запуск приложения](#2-запуск-приложения)
    - [Предварительная настройка служебных информационных баз 1с](#предварительная-настройка-служебных-информационных-баз-1с)
    - [Обычный запуск](#обычный-запуск)
    - [Запуск как служба Windows](#запуск-как-служба-windows)
    - [Запуск как сервис Linux (systemd)](#запуск-как-сервис-linux-systemd)
      - [1.  **Создайте файл юнита:**](#1--создайте-файл-юнита)
      - [2.  **Управление сервисом:**](#2--управление-сервисом)
  - [3. Диаграммы процессов](#3-диаграммы-процессов)

---

## 1. Структура конфигурационного файла `config.json`

Это основной файл, управляющий поведением приложения. Он состоит из глобальных настроек и списка проектов. Пример файла [config.json](./config.json).

### Глобальные настройки

| Ключ | Тип | Описание | Пример |
|---|---|---|---|
| `log_level` | string | Уровень детализации логов. Допустимые значения: `debug`, `info`, `warn`, `error`. | `"info"` |
| `app_log_dir` | string | Путь к каталогу логов. | `"logs"` |
| `catalog_1cv8` | string | **(Обязательный)** Глобальный путь к каталогу `bin` установки 1С. Используется, если для проекта не указан свой путь. | `"C:\Program Files\1cv8\8.3.25.1000\bin"` |
| `projects` | array | Массив объектов, где каждый объект описывает один проект для обработки. | `[...]` |

### Настройки проекта (объект в массиве `projects`)

Каждый проект представляет собой одну задачу по выгрузке хранилища 1С в Git.

| Ключ | Тип | Описание | Пример |
|---|---|---|---|
| `project` | string | **(Обязательный)** Уникальное имя проекта. Используется в логах. | `"ERP_Main_Repo"` |
| `catalog_1cv8` | string | *(Необязательный)* Индивидуальный путь к каталогу `bin` 1С для этого проекта. **Переопределяет глобальный `catalog_1cv8`**. | `"C:\Program Files\1cv8\8.3.24.1500\bin"` |
| `enabled` | boolean | Включает или отключает обработку данного проекта. | `true` |
| `schedule` | string | Периодичность запуска по расписанию. Формат: "24h" (раз в день), "3h45m", "30m", "10s". | `"15m"` |
| `schedule_enabled` | boolean | Включает или отключает запуск по расписанию. Если `false`, проект выполнится только один раз при старте приложения. | `true` |
| `project_data_path` | string | **(Обязательный)** Путь к каталогу, где будут храниться рабочие файлы проекта (отчеты, файлы версий и т.д.). | `"C:/ws/my/go/storage_to_git/projects_data/project_1"` |
| `users_file_path` | string | **(Обязательный)** Путь к файлу `users.csv` (сопоставление пользователей хранилища и Git). Путь относителен `project_data_path`. | `"users.csv"` |
| `versions_file_path` | string | **(Обязательный)** Путь к файлу `versions.json` (хранит последнюю обработанную версию). Путь относителен `project_data_path`. | `"versions.json"` |
| `v8_log_file_path` | string | **(Обязательный)** Путь к файлу лога для команд 1С. Путь относителен `project_data_path`. | `"1c_log.txt"` |
| `git_repository_path` | string | **(Обязательный)** Локальный путь к основному Git-репозиторию, куда будут выгружаться исходники. | `"C:/ws/my/go/storage_to_git/demo/project_1/git_repo/"` |
| `git_remote_url` | string | *(Необязательный)* URL удаленного Git-репозитория. Используется при инициализации. | `"git@github.com:user/repo.git"` |
| `branch_name` | string | **(Обязательный)** Имя ветки в Git, с которой будет работать проект. | `"main"` |
| `git_push_enabled` | boolean | Включает `git push` в удаленный репозиторий. | `true` |
| `git_push_timing_after_each_commit` | boolean | Если `true`, `push` выполняется после каждого коммита. Если `false`, `push` выполняется один раз в конце, после обработки всех версий. | `false` |
| `infobase` | object | **(Обязательный)** Настройки подключения к информационной базе 1С. | `{...}` |
| `storage` | object | *(Необязательный)* Настройки основного хранилища конфигурации. | `{...}` |
| `extensions` | array | *(Необязательный)* Массив объектов с настройками хранилищ расширений. | `[...]` |

### Файл сопоставления пользователей (`users.csv`)

Ключ `users_file_path` в настройках проекта указывает путь к файлу `users.csv`. Этот файл **необходимо создать вручную** до первого запуска обработки проекта.

**Назначение:** Сопоставить имена пользователей из хранилища 1С с именами и email авторов коммитов в Git.

**Структура файла:**
*   Формат: CSV (разделитель — точка с запятой `;`)
*   Кодировка: UTF-8
*   Столбцы:
    1.  `UserName` — имя пользователя, как оно указано в хранилище 1С
    2.  `AuthorName` — имя автора, которое будет использоваться в Git (например, "John Doe")
    3.  `AuthorEmail` — email автора для коммитов (например, "johndoe@example.com")

**Пользователь по умолчанию:**

Если пользователь, совершивший действие в хранилище 1С, не будет найден в этом файле, система будет искать пользователя с именем `default`. Эту запись **необходимо обязательно добавить** в файл `users.csv`, чтобы обрабатывать такие случаи.

**Пример содержимого `users.csv`:**

```csv
ИвановИИ;Ivan Ivanov;ivanov.ii@company.com
ПетровПП;Petr Petrov;petrov.pp@company.com
default;Default User;default.user@company.com
```

#### Объект `infobase`

| Ключ | Тип | Описание |
|---|---|---|
| `infobase_path` | string | Путь к информационной базе (например, `File="C:\mybase";`). |
| `infobase_user` | string | Имя пользователя для подключения к ИБ. |
| `infobase_password` | string | Пароль пользователя для подключения к ИБ. |

#### Объект `storage` (основное хранилище)

| Ключ | Тип | Описание |
|---|---|---|
| `storage_path` | string | Путь к хранилищу конфигурации. |
| `storage_user` | string | Имя пользователя хранилища. |
| `storage_password` | string | Пароль пользователя хранилища. |
| `git_repository_path` | string | Путь внутри основного Git-репозитория (`git_repository_path` проекта), куда будут выгружаться исходники этой конфигурации. |

#### Объект `extensions` (элемент массива)

| Ключ | Тип | Описание |
|---|---|---|
| `extension_name` | string | Имя расширения (как оно задано в конфигураторе). |
| `storage_path` | string | Путь к хранилищу расширения. |
| `storage_user` | string | Имя пользователя хранилища. |
| `storage_password` | string | Пароль пользователя хранилища. |
| `git_repository_path` | string | Путь внутри основного Git-репозитория, куда будут выгружаться исходники этого расширения. |

---

## 2. Запуск приложения

### Предварительная настройка служебных информационных баз 1с

*Важно!
Для работы приложение не создает необходимых информационных баз, они должны быть созданы предварительно по пути указанном в ключе `infobase_path` каждого проекта. Если проект использует расширения конфигурации то в созданной информационной базе необходимо создать расширение с именем указываемом в ключе `extension_name` расширения проекта.

### Обычный запуск

Для отладки или ручного запуска используйте следующую команду из корневого каталога проекта:

```bash
# Для Windows
./storage_to_git.exe --config C:/path/to/your/config.json

# Для Linux
./storage_to_git --config /path/to/your/config.json

```
*   Флаг `--config` указывает путь к вашему файлу `config.json`.
*   Если флаг не указан, приложение будет искать `config.json` в том же каталоге, где находится исполняемый файл.

### Запуск как служба Windows

Для автоматического запуска в фоновом режиме рекомендуется использовать утилиту **NSSM (Non-Sucking Service Manager)**.

1.  **Скачайте NSSM** с официального сайта: [nssm.cc](https://nssm.cc/download)
2.  Распакуйте и поместите `nssm.exe` в удобное место (например, `C:\Windows\System32`).
3.  Откройте командную строку от имени администратора и выполните следующие команды:

    ```cmd
    :: 1. Установка службы
    nssm install StorageToGit

    :: 2. Указание пути к вашему приложению
    nssm set StorageToGit Application "C:\path\to\your\storage_to_git.exe"

    :: 3. Указание флагов запуска (ОБЯЗАТЕЛЬНО!)
    nssm set StorageToGit AppParameters "--config C:\path\to\your\config.json"

    :: 4. Указание рабочего каталога
    nssm set StorageToGit AppDirectory "C:\path\to\your\app"

    :: 5. Запуск службы
    nssm start StorageToGit
    ```

**Управление службой:**
*   `nssm start StorageToGit` - запустить
*   `nssm stop StorageToGit` - остановить
*   `nssm restart StorageToGit` - перезапустить
*   `nssm status StorageToGit` - проверить статус
*   `nssm remove StorageToGit` - удалить службу

### Запуск как сервис Linux (systemd)

Для современных дистрибутивов Linux (Ubuntu, CentOS, Debian) используется `systemd`.

#### 1.  **Создайте файл юнита:**

    Создайте файл `/etc/systemd/system/storage_to_git.service` со следующим содержимым:

    ```ini
    [Unit]
    Description=Storage To Git Service
    After=network.target

    [Service]
    User=your_user                 # Укажите пользователя, от которого будет работать сервис
    Group=your_group               # Укажите группу этого пользователя
    WorkingDirectory=/path/to/your/app # Путь к каталогу с приложением
    ExecStart=/path/to/your/app/storage_to_git --config /path/to/your/app/config.json
    Restart=always
    RestartSec=10

    [Install]
    WantedBy=multi-user.target
    ```

    **Важно:** Замените `your_user`, `your_group` и пути на ваши реальные значения.

#### 2.  **Управление сервисом:**

    Выполните следующие команды в терминале:

    ```bash
    # Перечитать конфигурацию systemd
    sudo systemctl daemon-reload

    # Включить автозапуск сервиса при старте системы
    sudo systemctl enable storage_to_git.service

    # Запустить сервис сейчас
    sudo systemctl start storage_to_git.service

    # Проверить статус сервиса
    sudo systemctl status storage_to_git.service
    ```

---

## 3. Диаграммы процессов

Для наглядности представлены две диаграммы, описывающие работу приложения.

* [**Общая схема работы**](./overview_diagram.puml)
* [**Последовательность выполнения проекта**](./sequence_diagram.puml)
